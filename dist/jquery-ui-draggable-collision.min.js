/* Copyright (c) 2014 Djuri Baars, 2011 Sean Cusack, License: MIT */
!function(a){function b(a,b,c,d,e){jQuery.Event.call(this,a),this.collider=b,this.obstacle=c,this.collisionType=d,this.collision=e}function c(a,b,c,d){jQuery.Event.call(this,a),this.collider=b,this.obstacle=c,this.collisionType=d}function d(a,b,c,d){this.x1=a,this.y1=b,this.x2=c,this.y2=d}function e(a){if(a.length<=0)return null;for(var b=0,c=0,e=0,f=0;f<a.length;f++)e+=a[f].area(),b+=a[f].centerx()*a[f].area(),c+=a[f].centery()*a[f].area();var g=Math.sqrt(e);return new d(b/e-g/2,c/e-g/2,b/e+g/2,c/e+g/2)}function f(a,b,c){var e,f,g,h;return b||(b=0),c||(c=0),a.parent().length>0?(e=b+a.offset().left-(parseInt(a.css("margin-left"))||0),f=c+a.offset().top-(parseInt(a.css("margin-top"))||0),g=e+a.outerWidth(!0),h=f+a.outerHeight(!0)):(e=b+parseInt(a.css("left"))||0,f=c+parseInt(a.css("top"))||0,g=e+parseInt(a.css("width"))||0,h=f+parseInt(a.css("height"))||0,g+=(parseInt(a.css("margin-left"))||0)+(parseInt(a.css("border-left"))||0)+(parseInt(a.css("padding-left"))||0)+(parseInt(a.css("padding-right"))||0)+(parseInt(a.css("border-right"))||0)+(parseInt(a.css("margin-right"))||0),h+=(parseInt(a.css("margin-top"))||0)+(parseInt(a.css("border-top"))||0)+(parseInt(a.css("padding-top"))||0)+(parseInt(a.css("padding-bottom"))||0)+(parseInt(a.css("border-bottom"))||0)+(parseInt(a.css("margin-bottom"))||0)),new d(e,f,g,h)}function g(b,c,d){return e(b.toArray().map(function(b){return f(a(b),c,d)}))}function h(b,c,d,e,h,i,j,k,l,m){k||(k=g(a(this.collider),h,i)),h||(h=0),i||(i=0),this.collision=a(b),this.collider=a(b.data(c)),this.obstacle=a(b.data(d)),this.direction=b.data(j),this.type=e,this.dx=h,this.dy=i,this.centerOfMass=k,this.collisionCoords=f(this.collision),this.colliderCoords=f(this.collider,h,i),this.obstacleCoords=f(this.obstacle),l||(l=this.colliderCoords.centerx()),m||(l=this.colliderCoords.centery()),this.mousex=l,this.mousey=m}function i(a,b){var c=a.distance(),d=b.distance();return d>c?-1:c>d?1:0}function j(b,c){this.draggable=a(b),this.obstacleSelector=c.obstacle||".ui-draggable-collision-obstacle",this.restraintSelector=c.restraint||".ui-draggable-collision-restraint",this.obstacle=a(c.obstacle||".ui-draggable-collision-obstacle"),this.restraint=a(c.restraint||".ui-draggable-collision-restraint");var d=c.collider||".ui-draggable-dragging";this.collider=b.find(d).andSelf().filter(d),this.colliderData=c.colliderData||null,this.obstacleData=c.obstacleData||null,this.directionData=c.directionData||null,this.relative=c.relative||"body",this.preventCollision=c.preventCollision||!1,this.preventProtrusion=c.preventProtrusion||!1,this.collisions=a(),this.protrusions=a()}function k(b,c,d,e,f){a.ui.plugin.call(c,d,e,f),b.trigger(e,f)}function l(){{var b=a(this).data("ui-draggable");b.options}}function m(b,c){r=a(this).data("ui-draggable").options.collisionVisualDebug,a(this).data("jquery-ui-draggable-collision-recent-position",c.originalPosition)}function n(){a(this).removeData("jquery-ui-draggable-collision-recent-position"),r&&a(".testdebug").remove(),r=q}function o(d,e){var i=a(this).data("jquery-ui-draggable-collision-recent-position");q&&console.log("handleCollision ******************************************************************"),r&&a(".testdebug").remove();var l="collision",m="precollision",n="postcollision",o="protrusion",s="preprotrusion",t="postprotrusion",u=a(this).data("ui-draggable"),v=u.options,w=[];if((v.obstacle||v.restraint)&&w.push(new j(a(this),v)),v.multipleCollisionInteractions&&v.multipleCollisionInteractions.length)for(var x=v.multipleCollisionInteractions,y=0;y<x.length;y++)w.push(new j(a(this),x[y]));if(w.length<=0)return void a(this).data("jquery-ui-draggable-collision-recent-position",e.position);var z="ui-draggable-collision-collider-temp",A="ui-draggable-collision-obstacle-temp",B="ui-draggable-collision-direction-temp",C="ui-draggable-collision-interaction-temp",D=d.data,E="<div />";D&&D.as&&(E=D.as);for(var F,G=1,y=0;y<w.length;y++)G+=2*w[y].collider.length*(w[y].obstacle.length+w[y].restraint.length),r&&(w[y].obstacle.each(function(){a(this).clone().removeClass().empty().addClass("testdebug").css("pointer-events","none").css("background","transparent").css("padding","0px").css("border","1px solid black").css("margin","-1px").appendTo(a(this).parent())}),w[y].restraint.each(function(){a(this).clone().removeClass().empty().addClass("testdebug").css("pointer-events","none").css("background","transparent").css("padding","0px").css("border","1px solid magenta").css("margin","-1px").appendTo(a(this).parent())})),w[y].obstacleSelector&&(F=new c(m,a(this),w[y].obstacle,l),k(w[y].collider,u,m,F,e)),w[y].restraintSelector&&(F=new c(s,a(this),w[y].restraint,o),k(w[y].collider,u,s,F,e));var H,I,J=i.left,K=i.top,L=e.position.left-i.left,M=e.position.top-i.top,N=[],O=[],P=[],Q=[],R=a();if(u.containment){G+=2;var S=u.containment;R=a("<div />").offset({left:S[0],top:S[1]}).width(S[2]-S[0]+a(this).width()).height(S[3]-S[1]+a(this).height()),r&&R.clone().css("background","transparent").css("border","1px solid blue").css("margin","-1px").css("padding","0px").addClass("testdebug").appendTo()}for(var T={},U=0;G>U;){U++,H=e.position.left-i.left,I=e.position.top-i.top,N=[],O=[],P=[];for(var y=0;y<w.length;y++){w[y].collisions=a(),w[y].protrusions=a();var V=w[y].collider,W=w[y].obstacle,X=w[y].restraint;q&&console.log("trying inter,c,o,r=",w[y],V,W,X),V.each(function(){a(this).data("jquery-collision-coordinates",f(a(this),H,I))});for(var Y=g(V),Z=0;Z<V.length;Z++){var $=a(V[Z]).collision(W,{mode:"collision",as:"<div />",colliderData:z,obstacleData:A,directionData:B,relative:"body"});q&&console.log("collisions",$),$.data(C,w[y]),w[y].collisions=w[y].collisions.add($),$.length>0&&(O=$.toArray().map(function(b){return new h(a(b),z,A,"collision",H,I,B,Y,d.pageX,d.pageY)}),N=N.concat(O),r&&a("<span>c"+U+"</span>").appendTo($.addClass("testdebug").css("position","absolute").css("padding","0px").css("border","1px solid black").css("margin","-1").appendTo("body"))),$=a(V[Z]).collision(X,{mode:"protrusion",as:"<div />",colliderData:z,obstacleData:A,directionData:B,relative:"body"}),q&&console.log("protrusions",$),$.data(C,w[y]),w[y].protrusions=w[y].protrusions.add($),$.length>0&&(P=$.toArray().map(function(b){return new h(a(b),z,A,"protrusion",H,I,B,Y,d.pageX,d.pageY)}),N=N.concat(P),r&&a("<span>p"+U+"</span>").appendTo($.addClass("testdebug").css("position","absolute").css("padding","0px").css("border","1px solid magenta").css("margin","-1").appendTo("body")))}V.each(function(){a(this).removeData("jquery-collision-coordinates")})}if(u.containment){a(this).each(function(){a(this).data("jquery-collision-coordinates",f(a(this),H,I))});var _=a(this).collision(R,{mode:"protrusion",as:"<div />",colliderData:z,obstacleData:A,directionData:B,relative:"body"});Q=_.toArray().map(function(b){return new h(a(b),z,A,"protrusion",H,I,B,g(V),d.pageX,d.pageY)}),r&&a("<span>x"+U+"</span>").appendTo(_.addClass("testdebug").css("position","absolute").css("padding","0px").css("border","1px solid blue").css("margin","-1").appendTo("body")),a(this).each(function(){a(this).removeData("jquery-collision-coordinates")})}if(q&&console.log("checking if we have any collisions at all..."),O.length<=0&&P.length<=0&&Q.length<=0)break;for(var ab=!0,y=0;y<w.length;y++)q&&console.log("checking adjustments for",w[y],"ccl=",Q,"pc,cl,pp,pl=",w[y].preventCollision,w[y].collisions.length,w[y].preventProtrusion,w[y].protrusions.length),q&&console.log("checking if we overstepped our containment..."),!w[y].preventCollision&&!w[y].preventProtrusion&&Q.length>0&&(q&&console.log("not trying to prevent anything, but jumped our containment",w[y]),ab=!1),q&&console.log("checking if we want to block something we have collided with..."),(w[y].preventCollision&&(w[y].collisions.length>0||Q.length>0)||w[y].preventProtrusion&&(w[y].protrusions.length>0||Q.length>0))&&(q&&console.log("trying to prevent something that we're still hitting",w[y]),ab=!1);if(ab){q&&console.log("done adjusting");break}q&&console.log("calculating delta with ocl,ccl=",N,Q);var D=p(N.concat(),Q,T);if(q&&console.log("dx=",D.dx,"dy=",D.dy),0==D.dx&&0==D.dy)break;e.position.left+=D.dx,e.position.top+=D.dy}H=e.position.left-i.left,I=e.position.top-i.top,(U>G||Q.length>0||v.preventProtrusion&&P.length>0||v.preventCollision&&O.length>0)&&(q&&console.log("reverting, i=",U,"maxiter=",G,"cocl=",O,"cocl.len=",O.length,"pocl=",P,"pocl.len=",P.length,"ccl=",Q,"ccl.len=",Q.length,"origdx=",L,"origdy=",M,"dx=",H,"dy=",I),e.position.left=J,e.position.top=K);for(var Z=0;Z<N.length;Z++)for(var $=N[Z],bb=0;bb<$.collision.length;bb++){var cb=a($.collision[bb]),db=a(cb.data(z)),eb=a(cb.data(A)),fb=cb.data(B),gb=cb.data(C);if(cb.removeData(z).removeData(A).removeData(B).removeData(C),gb.colliderData&&cb.data(gb.colliderData,db),gb.obstacleData&&cb.data(gb.obstacleData,eb),fb&&gb.directionData&&cb.data(gb.directionData,fb),gb.relative&&"body"!=gb.relative){var hb=cb.offset(),ib="collider"==gb.relative?db:"obstacle"==gb.relative?eb:a(gb.relative),jb=ib.offset();cb.offset({left:hb.left-jb.left,top:hb.top-jb.top})}gb.obstacleSelector&&"collision"==$.type&&(F=new b(l,db,eb,l,cb),k(db,u,l,F,e)),gb.restraintSelector&&"protrusion"==$.type&&(F=new b(o,db,eb,o,cb),k(db,u,o,F,e))}for(var y=0;y<w.length;y++)w[y].obstacleSelector&&(F=new c(n,a(this),w[y].obstacle,l),k(w[y].collider,u,n,F,e)),w[y].restraintSelector&&(F=new c(t,a(this),w[y].restraint,o),k(w[y].collider,u,t,F,e));a(this).data("jquery-ui-draggable-collision-recent-position",e.position)}function p(b,c,d){var e=b.concat(c).sort(i);for(r&&(d.deltanum||(d.deltanum=1)),q&&console.log("collisions, in order: ",e.map(function(a){return a.collisionCoords.hash()}).join(","));e.length>0;){var f=e.pop(),g=f.obstacleCoords,h=f.colliderCoords,j=f.collisionCoords,k=f.type,l=(f.direction,f.hash()),m="protrusion"==f.type?h.centerx()>g.centerx()?-1:1:h.centerx()>g.centerx()?1:-1,n="protrusion"==f.type?h.centery()>g.centery()?-1:1:h.centery()>g.centery()?1:-1,o=f.embedx(m),p=f.embedy(n);q&&console.log("cv,cc,co,ct,dx,dy,thisc.dx,thisc.dy,dirx,diry,co.centerx,co.centery,cc.centerx,cc.centery,key=",j.hash(),h.hash(),g.hash(),k,o,p,f.dx,f.dy,m,n,g.centerx(),g.centery(),h.centerx(),h.centery(),l);var s=p>o;if(l in d&&"tried reverse"==d[l])q&&console.log("but already tried reverse too...");else{if(l in d&&"tried normal"==d[l]?(q&&console.log("but already tried this..."),s=!s,d[l]="tried reverse"):d[l]="tried normal",s){if(r&&(a("<span>"+f.direction+"d"+d.deltanum+".dx="+o+"*"+m+"</span>").css("color","black").addClass("testdebug").css("position","absolute").css("white-space","nowrap").offset({left:f.mousex,top:f.mousey+20*(d.deltanum-1)}).appendTo("body"),d.deltanum++),0>=o){e.push(f);continue}return{dx:o*m,dy:0}}if(r&&(a("<span>"+f.direction+"d"+d.deltanum+".dy="+p+"*"+n+"</span>").css("color","black").addClass("testdebug").css("position","absolute").css("white-space","nowrap").offset({left:f.mousex,top:f.mousey+20*(d.deltanum-1)}).appendTo("body"),d.deltanum++),!(0>=p))return{dx:0,dy:p*n};e.push(f)}}return{dx:0,dy:0}}var q=!1,r=q;a.ui.draggable.prototype.options.obstacle=".ui-draggable-collision-obstacle",a.ui.draggable.prototype.options.restraint=".ui-draggable-collision-restraint",a.ui.draggable.prototype.options.collider=".ui-draggable-dragging",a.ui.draggable.prototype.options.colliderData=null,a.ui.draggable.prototype.options.obstacleData=null,a.ui.draggable.prototype.options.directionData=null,a.ui.draggable.prototype.options.relative="body",a.ui.draggable.prototype.options.preventCollision=!1,a.ui.draggable.prototype.options.preventProtrusion=!1,a.ui.draggable.prototype.options.collisionVisualDebug=!1,a.ui.draggable.prototype.options.multipleCollisionInteractions=[],a.ui.plugin.add("draggable","obstacle",{create:function(a,b){l.call(this,a,b)},start:function(a,b){m.call(this,a,b)},drag:function(a,b){return o.call(this,a,b)},stop:function(a,b){o.call(this,a,b),n.call(this,a,b)}}),a.ui.plugin.add("draggable","restraint",{create:function(a,b){l.call(this,a,b)},start:function(b,c){a(this).data("ui-draggable").options.obstacle||m.call(this,b,c)},drag:function(b,c){return a(this).data("ui-draggable").options.obstacle?void 0:o.call(this,b,c)},stop:function(b,c){a(this).data("ui-draggable").options.obstacle||(o.call(this,b,c),n.call(this,b,c))}}),a.ui.plugin.add("draggable","multipleCollisionInteractions",{create:function(a,b){l.call(this,a,b)},start:function(b,c){a(this).data("ui-draggable").options.obstacle||a(this).data("ui-draggable").options.restraint||m.call(this,b,c)},drag:function(b,c){return a(this).data("ui-draggable").options.obstacle||a(this).data("ui-draggable").options.restraint?void 0:o.call(this,b,c)},stop:function(b,c){a(this).data("ui-draggable").options.obstacle||a(this).data("ui-draggable").options.restraint||(o.call(this,b,c),n.call(this,b,c))}}),b.prototype=new a.Event(""),c.prototype=new a.Event(""),d.prototype.width=function(){return this.x2-this.x1},d.prototype.height=function(){return this.y2+this.y1},d.prototype.centerx=function(){return(this.x1+this.x2)/2},d.prototype.centery=function(){return(this.y1+this.y2)/2},d.prototype.area=function(){return this.width()*this.height()},d.prototype.hash=function(){return"["+[this.x1,this.y1,this.x2,this.y2].join(",")+"]"},d.prototype.distance=function(a){return this.distanceTo(a.centerx(),a.centery())},d.prototype.distanceTo=function(a,b){var c=this.centerx()-a,d=this.centerx()-b;return Math.sqrt(c*c+d*d)},h.prototype.embedx=function(a){if("collision"==this.type){if(0>a)return this.colliderCoords.x2-this.obstacleCoords.x1;if(a>0)return this.obstacleCoords.x2-this.colliderCoords.x1}else if("protrusion"==this.type){if("N"==this.direction||"S"==this.direction)return 0;if(0>a)return this.colliderCoords.x2-this.obstacleCoords.x2;if(a>0)return this.obstacleCoords.x1-this.colliderCoords.x1}return 0},h.prototype.embedy=function(a){if("collision"==this.type){if(0>a)return this.colliderCoords.y2-this.obstacleCoords.y1;if(a>0)return this.obstacleCoords.y2-this.colliderCoords.y1}else if("protrusion"==this.type){if("E"==this.direction||"W"==this.direction)return 0;if(0>a)return this.colliderCoords.y2-this.obstacleCoords.y2;if(a>0)return this.obstacleCoords.y1-this.colliderCoords.y1}return 0},h.prototype.distance=function(){var a=this.centerOfMass.centerx(),b=this.centerOfMass.centery(),c=this.collisionCoords.centerx(),d=this.collisionCoords.centery();return Math.sqrt((c-a)*(c-a)+(d-b)*(d-b))},h.prototype.hash=function(){return this.type+"["+this.colliderCoords.hash()+","+this.obstacleCoords.hash()+"]"}}(jQuery);
//# sourceMappingURL=jquery-ui-draggable-collision.min.js.map